#!/usr/local/bin/pike
/*
Simple way to quickly eyeball a text file in an unknown encoding.

Calls on chardet(1) to make an educated guess as to what encoding seems most
likely, then decodes the file using that, and pipes it into less(1). If the
selected encoding is incorrect, it can be quickly overridden with a second
argument. The original file is not mutated in any way.
*/

int main(int argc,array(string) argv)
{
	if (argc<2) exit(0,"USAGE: %s filename [encoding]\n",argv[0]);
	string data=Stdio.read_file(argv[1]);
	string enc;
	if (argc>2) enc=argv[2];
	else sscanf(Process.run(({"chardet"}),(["stdin":data]))->stdout,"<stdin>: %s with confidence",enc);
	string txt=Charset.decoder(enc)->feed(data)->drain();
	Stdio.File send=Stdio.File(),recv=send->pipe();
	send->write("Selected encoding: %s\n\n",enc);
	send->write(string_to_utf8(txt)); send->close();
	Process.create_process(({"less"}),(["stdin":recv]))->wait();
}
